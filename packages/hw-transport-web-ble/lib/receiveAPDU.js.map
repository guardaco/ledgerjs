{"version":3,"sources":["../src/receiveAPDU.js"],"names":["TagId","receiveAPDU","rawStream","Observable","create","notifiedIndex","notifiedDataLength","notifiedData","Buffer","alloc","sub","subscribe","complete","o","error","TransportError","unsubscribe","logSubject","next","type","message","String","e","tag","value","readUInt8","index","readUInt16BE","data","slice","toString","concat","length"],"mappings":";;;;;;;AAEA;;AACA;;AACA;;AAEA,IAAMA,QAAQ,IAAd;;AAEA;;;AACO,IAAMC,oCAAc,SAAdA,WAAc,CACzBC,SADyB;AAAA,SAGzBC,iBAAWC,MAAX,CAAkB,aAAK;AACrB,QAAIC,gBAAgB,CAApB;AACA,QAAIC,qBAAqB,CAAzB;AACA,QAAIC,eAAeC,OAAOC,KAAP,CAAa,CAAb,CAAnB;;AAEA,QAAMC,MAAMR,UAAUS,SAAV,CAAoB;AAC9BC,gBAAU,oBAAM;AACdC,UAAEC,KAAF,CAAQ,IAAIC,2BAAJ,CAAmB,cAAnB,EAAmC,cAAnC,CAAR;AACAL,YAAIM,WAAJ;AACD,OAJ6B;AAK9BF,aAAO,kBAAK;AACVG,0BAAWC,IAAX,CAAgB;AACdC,gBAAM,WADQ;AAEdC,mBAAS,oBAAoBC,OAAOC,CAAP;AAFf,SAAhB;AAIAT,UAAEC,KAAF,CAAQQ,CAAR;AACAZ,YAAIM,WAAJ;AACD,OAZ6B;AAa9BE,YAAM,qBAAS;AACb,YAAMK,MAAMC,MAAMC,SAAN,CAAgB,CAAhB,CAAZ;AACA,YAAMC,QAAQF,MAAMG,YAAN,CAAmB,CAAnB,CAAd;AACA,YAAIC,OAAOJ,MAAMK,KAAN,CAAY,CAAZ,CAAX;;AAEA,YAAIN,QAAQvB,KAAZ,EAAmB;AACjBa,YAAEC,KAAF,CACE,IAAIC,2BAAJ,CAAmB,iBAAiBQ,IAAIO,QAAJ,CAAa,EAAb,CAApC,EAAsD,YAAtD,CADF;AAGA;AACD;;AAED,YAAIzB,kBAAkBqB,KAAtB,EAA6B;AAC3Bb,YAAEC,KAAF,CACE,IAAIC,2BAAJ,CACE,gEACEW,KADF,GAEE,gBAFF,GAGErB,aAJJ,EAKE,iBALF,CADF;AASA;AACD;;AAED,YAAIqB,UAAU,CAAd,EAAiB;AACfpB,+BAAqBsB,KAAKD,YAAL,CAAkB,CAAlB,CAArB;AACAC,iBAAOA,KAAKC,KAAL,CAAW,CAAX,CAAP;AACD;AACDxB;AACAE,uBAAeC,OAAOuB,MAAP,CAAc,CAACxB,YAAD,EAAeqB,IAAf,CAAd,CAAf;AACA,YAAIrB,aAAayB,MAAb,GAAsB1B,kBAA1B,EAA8C;AAC5CO,YAAEC,KAAF,CACE,IAAIC,2BAAJ,CACE,+DACER,aAAayB,MADf,GAEE,gBAFF,GAGE1B,kBAJJ,EAKE,gBALF,CADF;AASA;AACD;AACD,YAAIC,aAAayB,MAAb,KAAwB1B,kBAA5B,EAAgD;AAC9CO,YAAEK,IAAF,CAAOX,YAAP;AACAM,YAAED,QAAF;AACAF,cAAIM,WAAJ;AACD;AACF;AA7D6B,KAApB,CAAZ;;AAgEA,WAAO,YAAM;AACXN,UAAIM,WAAJ;AACD,KAFD;AAGD,GAxED,CAHyB;AAAA,CAApB","file":"receiveAPDU.js","sourcesContent":["// @flow\n\nimport { TransportError } from \"@ledgerhq/hw-transport\";\nimport { Observable } from \"rxjs\";\nimport { logSubject } from \"./debug\";\n\nconst TagId = 0x05;\n\n// operator that transform the input raw stream into one apdu response and finishes\nexport const receiveAPDU = (\n  rawStream: Observable<Buffer>\n): Observable<Buffer> =>\n  Observable.create(o => {\n    let notifiedIndex = 0;\n    let notifiedDataLength = 0;\n    let notifiedData = Buffer.alloc(0);\n\n    const sub = rawStream.subscribe({\n      complete: () => {\n        o.error(new TransportError(\"Disconnected\", \"Disconnected\"));\n        sub.unsubscribe();\n      },\n      error: e => {\n        logSubject.next({\n          type: \"ble-error\",\n          message: \"in receiveAPDU \" + String(e)\n        });\n        o.error(e);\n        sub.unsubscribe();\n      },\n      next: value => {\n        const tag = value.readUInt8(0);\n        const index = value.readUInt16BE(1);\n        let data = value.slice(3);\n\n        if (tag !== TagId) {\n          o.error(\n            new TransportError(\"Invalid tag \" + tag.toString(16), \"InvalidTag\")\n          );\n          return;\n        }\n\n        if (notifiedIndex !== index) {\n          o.error(\n            new TransportError(\n              \"BLE: Invalid sequence number. discontinued chunk. Received \" +\n                index +\n                \" but expected \" +\n                notifiedIndex,\n              \"InvalidSequence\"\n            )\n          );\n          return;\n        }\n\n        if (index === 0) {\n          notifiedDataLength = data.readUInt16BE(0);\n          data = data.slice(2);\n        }\n        notifiedIndex++;\n        notifiedData = Buffer.concat([notifiedData, data]);\n        if (notifiedData.length > notifiedDataLength) {\n          o.error(\n            new TransportError(\n              \"BLE: received too much data. discontinued chunk. Received \" +\n                notifiedData.length +\n                \" but expected \" +\n                notifiedDataLength,\n              \"BLETooMuchData\"\n            )\n          );\n          return;\n        }\n        if (notifiedData.length === notifiedDataLength) {\n          o.next(notifiedData);\n          o.complete();\n          sub.unsubscribe();\n        }\n      }\n    });\n\n    return () => {\n      sub.unsubscribe();\n    };\n  });\n"]}